<!DOCTYPE html>
<html lang="" xml:lang="">
<head>

  <meta charset="utf-8" />
  <meta http-equiv="X-UA-Compatible" content="IE=edge" />
  <title>Chapter 20 Evaluation | Advanced R Companion</title>
  <meta name="description" content="This is a companion to Advanced R and supplement to Advanced R Solutions." />
  <meta name="generator" content="bookdown 0.20 and GitBook 2.6.7" />

  <meta property="og:title" content="Chapter 20 Evaluation | Advanced R Companion" />
  <meta property="og:type" content="book" />
  
  
  <meta property="og:description" content="This is a companion to Advanced R and supplement to Advanced R Solutions." />
  <meta name="github-repo" content="rstudio/bookdown-demo" />

  <meta name="twitter:card" content="summary" />
  <meta name="twitter:title" content="Chapter 20 Evaluation | Advanced R Companion" />
  
  <meta name="twitter:description" content="This is a companion to Advanced R and supplement to Advanced R Solutions." />
  

<meta name="author" content="R4DS Reading Group" />


<meta name="date" content="2020-08-07" />

  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <meta name="apple-mobile-web-app-capable" content="yes" />
  <meta name="apple-mobile-web-app-status-bar-style" content="black" />
  
  
<link rel="prev" href="quasiquotation.html"/>

<script src="libs/jquery-2.2.3/jquery.min.js"></script>
<link href="libs/gitbook-2.6.7/css/style.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-table.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-bookdown.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-highlight.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-search.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-fontsettings.css" rel="stylesheet" />
<link href="libs/gitbook-2.6.7/css/plugin-clipboard.css" rel="stylesheet" />











<style type="text/css">
a.sourceLine { display: inline-block; line-height: 1.25; }
a.sourceLine { pointer-events: none; color: inherit; text-decoration: inherit; }
a.sourceLine:empty { height: 1.2em; }
.sourceCode { overflow: visible; }
code.sourceCode { white-space: pre; position: relative; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
code.sourceCode { white-space: pre-wrap; }
a.sourceLine { text-indent: -1em; padding-left: 1em; }
}
pre.numberSource a.sourceLine
  { position: relative; left: -4em; }
pre.numberSource a.sourceLine::before
  { content: attr(data-line-number);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; pointer-events: all; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    color: #aaaaaa;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #aaaaaa;  padding-left: 4px; }
div.sourceCode
  {  }
@media screen {
a.sourceLine::before { text-decoration: underline; }
}
code span.al { color: #ff0000; font-weight: bold; } /* Alert */
code span.an { color: #60a0b0; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { color: #7d9029; } /* Attribute */
code span.bn { color: #40a070; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #007020; font-weight: bold; } /* ControlFlow */
code span.ch { color: #4070a0; } /* Char */
code span.cn { color: #880000; } /* Constant */
code span.co { color: #60a0b0; font-style: italic; } /* Comment */
code span.cv { color: #60a0b0; font-weight: bold; font-style: italic; } /* CommentVar */
code span.do { color: #ba2121; font-style: italic; } /* Documentation */
code span.dt { color: #902000; } /* DataType */
code span.dv { color: #40a070; } /* DecVal */
code span.er { color: #ff0000; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #40a070; } /* Float */
code span.fu { color: #06287e; } /* Function */
code span.im { } /* Import */
code span.in { color: #60a0b0; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #007020; font-weight: bold; } /* Keyword */
code span.op { color: #666666; } /* Operator */
code span.ot { color: #007020; } /* Other */
code span.pp { color: #bc7a00; } /* Preprocessor */
code span.sc { color: #4070a0; } /* SpecialChar */
code span.ss { color: #bb6688; } /* SpecialString */
code span.st { color: #4070a0; } /* String */
code span.va { color: #19177c; } /* Variable */
code span.vs { color: #4070a0; } /* VerbatimString */
code span.wa { color: #60a0b0; font-weight: bold; font-style: italic; } /* Warning */
</style>

<link rel="stylesheet" href="style.css" type="text/css" />
</head>

<body>



  <div class="book without-animation with-summary font-size-2 font-family-1" data-basepath=".">

    <div class="book-summary">
      <nav role="navigation">

<ul class="summary">
<img src="images/r4ds.png" style="width:300px;height:180px;padding-bottom:0px;"></img>

<li class="divider"></li>
<li class="chapter" data-level="1" data-path="welcome.html"><a href="welcome.html"><i class="fa fa-check"></i><b>1</b> Welcome</a></li>
<li class="chapter" data-level="2" data-path="names-and-values.html"><a href="names-and-values.html"><i class="fa fa-check"></i><b>2</b> Names and Values</a><ul>
<li class="chapter" data-level="" data-path="names-and-values.html"><a href="names-and-values.html#binding-basics"><i class="fa fa-check"></i>2.2 Binding basics</a></li>
<li class="chapter" data-level="" data-path="names-and-values.html"><a href="names-and-values.html#copy-on-modify"><i class="fa fa-check"></i>2.3 Copy-on-modify</a></li>
<li class="chapter" data-level="" data-path="names-and-values.html"><a href="names-and-values.html#exercises"><i class="fa fa-check"></i>2.2.2 Exercises</a></li>
<li class="chapter" data-level="" data-path="names-and-values.html"><a href="names-and-values.html#function-calls"><i class="fa fa-check"></i>2.3.2 Function calls</a></li>
<li class="chapter" data-level="" data-path="names-and-values.html"><a href="names-and-values.html#lists"><i class="fa fa-check"></i>2.3.3 Lists</a></li>
<li class="chapter" data-level="" data-path="names-and-values.html"><a href="names-and-values.html#character-vectors"><i class="fa fa-check"></i>2.3.5 Character vectors</a></li>
<li class="chapter" data-level="" data-path="names-and-values.html"><a href="names-and-values.html#exercise"><i class="fa fa-check"></i>2.3.6.2 Exercise</a></li>
<li class="chapter" data-level="" data-path="names-and-values.html"><a href="names-and-values.html#object-size"><i class="fa fa-check"></i>2.4.1 Object size</a></li>
<li class="chapter" data-level="" data-path="names-and-values.html"><a href="names-and-values.html#modify-in-place"><i class="fa fa-check"></i>2.5.1 Modify-in-place</a></li>
</ul></li>
<li class="chapter" data-level="3" data-path="vectors.html"><a href="vectors.html"><i class="fa fa-check"></i><b>3</b> Vectors</a><ul>
<li class="chapter" data-level="" data-path="vectors.html"><a href="vectors.html#scalars"><i class="fa fa-check"></i>3.2.1 Scalars</a></li>
<li class="chapter" data-level="" data-path="vectors.html"><a href="vectors.html#missing-values"><i class="fa fa-check"></i>3.2.3 Missing values</a></li>
<li class="chapter" data-level="" data-path="vectors.html"><a href="vectors.html#testing-and-coercion"><i class="fa fa-check"></i>3.2.4 Testing and coercion</a></li>
<li class="chapter" data-level="" data-path="vectors.html"><a href="vectors.html#setting-attributes"><i class="fa fa-check"></i>3.3.1 Setting Attributes</a></li>
<li class="chapter" data-level="" data-path="vectors.html"><a href="vectors.html#setnames"><i class="fa fa-check"></i>3.3.2 setNames</a></li>
<li class="chapter" data-level="" data-path="vectors.html"><a href="vectors.html#dimensions"><i class="fa fa-check"></i>3.3.3 Dimensions</a></li>
<li class="chapter" data-level="" data-path="vectors.html"><a href="vectors.html#s3-atomic-vectors"><i class="fa fa-check"></i>3.4 S3 atomic vectors</a></li>
<li class="chapter" data-level="" data-path="vectors.html"><a href="vectors.html#dates"><i class="fa fa-check"></i>3.4.2 Dates</a></li>
<li class="chapter" data-level="" data-path="names-and-values.html"><a href="names-and-values.html#lists"><i class="fa fa-check"></i>3.5.1 Lists</a></li>
<li class="chapter" data-level="" data-path="vectors.html"><a href="vectors.html#data-frames-and-tibbles"><i class="fa fa-check"></i>3.6.8 Data frames and tibbles</a></li>
<li class="chapter" data-level="" data-path="vectors.html"><a href="vectors.html#conclusion"><i class="fa fa-check"></i>Conclusion</a><ul>
<li class="chapter" data-level="" data-path="vectors.html"><a href="vectors.html#vectorized"><i class="fa fa-check"></i>VECTORIZED:</a></li>
<li class="chapter" data-level="" data-path="vectors.html"><a href="vectors.html#non-vectorized"><i class="fa fa-check"></i>NON-VECTORIZED:</a></li>
</ul></li>
</ul></li>
<li class="chapter" data-level="4" data-path="subsetting.html"><a href="subsetting.html"><i class="fa fa-check"></i><b>4</b> Subsetting</a><ul>
<li class="chapter" data-level="" data-path="subsetting.html"><a href="subsetting.html#introduction"><i class="fa fa-check"></i>4.1 Introduction</a></li>
<li class="chapter" data-level="" data-path="subsetting.html"><a href="subsetting.html#selecting-multiple-elements"><i class="fa fa-check"></i>4.2.1 Selecting multiple elements</a></li>
<li class="chapter" data-level="" data-path="names-and-values.html"><a href="names-and-values.html#lists"><i class="fa fa-check"></i>4.2.2 lists</a></li>
<li><a href="subsetting.html#section">4.3.1 <code>[[</code></a></li>
<li class="chapter" data-level="" data-path="names-and-values.html"><a href="names-and-values.html#exercise"><i class="fa fa-check"></i>4.3.5 Exercise</a></li>
<li class="chapter" data-level="" data-path="subsetting.html"><a href="subsetting.html#missing-and-oob"><i class="fa fa-check"></i>4.3.3 Missing and OOB</a><ul>
<li class="chapter" data-level="" data-path="subsetting.html"><a href="subsetting.html#logical-atomic"><i class="fa fa-check"></i>LOGICAL ATOMIC</a></li>
<li class="chapter" data-level="" data-path="subsetting.html"><a href="subsetting.html#list"><i class="fa fa-check"></i>LIST</a></li>
<li class="chapter" data-level="" data-path="subsetting.html"><a href="subsetting.html#null"><i class="fa fa-check"></i>NULL</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="subsetting.html"><a href="subsetting.html#logical-subsetting"><i class="fa fa-check"></i>4.5.8 Logical subsetting</a></li>
<li class="chapter" data-level="" data-path="subsetting.html"><a href="subsetting.html#boolean-algebra"><i class="fa fa-check"></i>4.5.8 Boolean algebra</a></li>
</ul></li>
<li class="chapter" data-level="5" data-path="control-flow.html"><a href="control-flow.html"><i class="fa fa-check"></i><b>5</b> Control Flow</a><ul>
<li class="chapter" data-level="" data-path="control-flow.html"><a href="control-flow.html#vectorised-if"><i class="fa fa-check"></i>5.2.2 Vectorised if</a></li>
<li class="chapter" data-level="" data-path="control-flow.html"><a href="control-flow.html#loops"><i class="fa fa-check"></i>5.3 Loops</a></li>
<li class="chapter" data-level="" data-path="control-flow.html"><a href="control-flow.html#switch-statement"><i class="fa fa-check"></i>5.2.3 switch statement</a></li>
<li class="chapter" data-level="" data-path="control-flow.html"><a href="control-flow.html#common-pitfalls"><i class="fa fa-check"></i>5.3.1 common pitfalls</a></li>
<li class="chapter" data-level="" data-path="names-and-values.html"><a href="names-and-values.html#exercises"><i class="fa fa-check"></i>5.3.3.1 Exercises</a><ul>
<li class="chapter" data-level="" data-path="control-flow.html"><a href="control-flow.html#assignment-to-a-valid-index"><i class="fa fa-check"></i>Assignment to a valid index</a></li>
<li class="chapter" data-level="" data-path="control-flow.html"><a href="control-flow.html#assignment-to-0"><i class="fa fa-check"></i>Assignment to [0]</a></li>
<li class="chapter" data-level="" data-path="control-flow.html"><a href="control-flow.html#empty-index"><i class="fa fa-check"></i>Empty index</a></li>
<li><a href="control-flow.html#impossible-index">Impossible Index <code>[[</code></a></li>
<li><a href="control-flow.html#impossible-index--">Impossible Index <code>[[&lt;-</code></a></li>
<li class="chapter" data-level="" data-path="control-flow.html"><a href="control-flow.html#undefined-name"><i class="fa fa-check"></i>Undefined name</a></li>
<li class="chapter" data-level="" data-path="control-flow.html"><a href="control-flow.html#out-of-bounds"><i class="fa fa-check"></i>Out of Bounds</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="vectors.html"><a href="vectors.html#conclusion"><i class="fa fa-check"></i>Conclusion</a></li>
<li class="chapter" data-level="" data-path="control-flow.html"><a href="control-flow.html#complexity"><i class="fa fa-check"></i>Complexity</a></li>
</ul></li>
<li class="chapter" data-level="6" data-path="functions.html"><a href="functions.html"><i class="fa fa-check"></i><b>6</b> Functions</a><ul>
<li class="chapter" data-level="" data-path="functions.html"><a href="functions.html#primitives"><i class="fa fa-check"></i>6.2.2 Primitives</a></li>
<li class="chapter" data-level="" data-path="names-and-values.html"><a href="names-and-values.html#exercises"><i class="fa fa-check"></i>6.2.5.1 Exercises</a></li>
<li class="chapter" data-level="" data-path="functions.html"><a href="functions.html#function-composition"><i class="fa fa-check"></i>6.3 Function composition</a><ul>
<li class="chapter" data-level="6.0.1" data-path="functions.html"><a href="functions.html#nested"><i class="fa fa-check"></i><b>6.0.1</b> Nested</a></li>
<li class="chapter" data-level="6.0.2" data-path="functions.html"><a href="functions.html#intermediate"><i class="fa fa-check"></i><b>6.0.2</b> Intermediate</a></li>
<li class="chapter" data-level="6.0.3" data-path="functions.html"><a href="functions.html#piping"><i class="fa fa-check"></i><b>6.0.3</b> Piping</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="functions.html"><a href="functions.html#lexical-scoping"><i class="fa fa-check"></i>6.4 Lexical scoping</a></li>
<li class="chapter" data-level="" data-path="functions.html"><a href="functions.html#a-fresh-start"><i class="fa fa-check"></i>6.4.3 A fresh start</a></li>
<li class="chapter" data-level="" data-path="functions.html"><a href="functions.html#lazy-evaluation"><i class="fa fa-check"></i>6.5 Lazy evaluation</a></li>
<li class="chapter" data-level="" data-path="functions.html"><a href="functions.html#promises"><i class="fa fa-check"></i>6.5.1 Promises</a></li>
<li class="chapter" data-level="" data-path="functions.html"><a href="functions.html#default-arguments"><i class="fa fa-check"></i>6.5.2 Default arguments</a></li>
<li class="chapter" data-level="" data-path="names-and-values.html"><a href="names-and-values.html#exercise"><i class="fa fa-check"></i>6.5.4.3 Exercise</a></li>
<li class="chapter" data-level="" data-path="functions.html"><a href="functions.html#exercise-1"><i class="fa fa-check"></i>6.5.4.4 Exercise</a></li>
<li class="chapter" data-level="" data-path="functions.html"><a href="functions.html#dot-dot-dot"><i class="fa fa-check"></i>6.6 dot dot dot</a></li>
<li class="chapter" data-level="" data-path="functions.html"><a href="functions.html#exercise-2"><i class="fa fa-check"></i>6.6.1.2 Exercise</a></li>
<li class="chapter" data-level="" data-path="functions.html"><a href="functions.html#exit-handlers"><i class="fa fa-check"></i>6.7.4 Exit handlers</a></li>
<li class="chapter" data-level="" data-path="functions.html"><a href="functions.html#exercise-3"><i class="fa fa-check"></i>6.7.5.4 Exercise</a></li>
<li class="chapter" data-level="" data-path="functions.html"><a href="functions.html#exercise-4"><i class="fa fa-check"></i>6.7.5.5 Exercise</a></li>
<li class="chapter" data-level="" data-path="functions.html"><a href="functions.html#replacement-functions"><i class="fa fa-check"></i>6.8.4 Replacement functions</a></li>
<li class="chapter" data-level="" data-path="functions.html"><a href="functions.html#exercise-5"><i class="fa fa-check"></i>6.8.6.3 Exercise</a></li>
</ul></li>
<li class="chapter" data-level="7" data-path="environments.html"><a href="environments.html"><i class="fa fa-check"></i><b>7</b> Environments</a><ul>
<li class="chapter" data-level="" data-path="environments.html"><a href="environments.html#parents"><i class="fa fa-check"></i>7.2.3 Parents</a></li>
<li class="chapter" data-level="" data-path="environments.html"><a href="environments.html#super-assignment"><i class="fa fa-check"></i>7.2.4 Super assignment</a></li>
<li class="chapter" data-level="" data-path="environments.html"><a href="environments.html#getting-and-setting"><i class="fa fa-check"></i>7.2.5 Getting and setting</a></li>
<li class="chapter" data-level="" data-path="environments.html"><a href="environments.html#advanced-bindings"><i class="fa fa-check"></i>7.2.6 Advanced bindings</a></li>
<li class="chapter" data-level="" data-path="environments.html"><a href="environments.html#recursing-over-environments"><i class="fa fa-check"></i>7.3 Recursing over environments</a></li>
<li class="chapter" data-level="" data-path="names-and-values.html"><a href="names-and-values.html#exercises"><i class="fa fa-check"></i>7.3.1.2 Exercises</a></li>
<li class="chapter" data-level="" data-path="environments.html"><a href="environments.html#function-enviornment"><i class="fa fa-check"></i>7.4.2 Function enviornment</a></li>
<li class="chapter" data-level="" data-path="environments.html"><a href="environments.html#namespaces"><i class="fa fa-check"></i>7.4.3 Namespaces</a></li>
<li class="chapter" data-level="" data-path="environments.html"><a href="environments.html#call-stacks"><i class="fa fa-check"></i>7.5 Call stacks</a></li>
<li class="chapter" data-level="" data-path="environments.html"><a href="environments.html#data-structures"><i class="fa fa-check"></i>7.6 Data Structures</a></li>
</ul></li>
<li class="chapter" data-level="8" data-path="conditions.html"><a href="conditions.html"><i class="fa fa-check"></i><b>8</b> Conditions</a><ul>
<li class="chapter" data-level="" data-path="conditions.html"><a href="conditions.html#ignoring-conditions"><i class="fa fa-check"></i>8.3 Ignoring conditions</a></li>
<li class="chapter" data-level="" data-path="conditions.html"><a href="conditions.html#exiting-handlers"><i class="fa fa-check"></i>8.4.2 Exiting handlers</a></li>
<li class="chapter" data-level="" data-path="conditions.html"><a href="conditions.html#calling-handlers"><i class="fa fa-check"></i>8.4.3 Calling handlers</a></li>
<li class="chapter" data-level="" data-path="names-and-values.html"><a href="names-and-values.html#exercises"><i class="fa fa-check"></i>8.4.5.2 Exercises</a></li>
<li class="chapter" data-level="" data-path="conditions.html"><a href="conditions.html#exercises-1"><i class="fa fa-check"></i>8.4.5.3 Exercises</a></li>
<li class="chapter" data-level="" data-path="conditions.html"><a href="conditions.html#resignal"><i class="fa fa-check"></i>8.6.3 Resignal</a></li>
<li class="chapter" data-level="" data-path="conditions.html"><a href="conditions.html#record"><i class="fa fa-check"></i>8.6.4 Record</a></li>
<li class="chapter" data-level="" data-path="conditions.html"><a href="conditions.html#exercises-2"><i class="fa fa-check"></i>8.6.6.2 Exercises</a></li>
<li class="chapter" data-level="" data-path="conditions.html"><a href="conditions.html#exercises-3"><i class="fa fa-check"></i>8.6.6.4 Exercises</a></li>
<li class="chapter" data-level="" data-path="conditions.html"><a href="conditions.html#slides"><i class="fa fa-check"></i>Slides</a></li>
</ul></li>
<li class="chapter" data-level="9" data-path="functionals.html"><a href="functionals.html"><i class="fa fa-check"></i><b>9</b> Functionals</a><ul>
<li class="chapter" data-level="" data-path="functionals.html"><a href="functionals.html#anonymous-functions-and-shortcuts"><i class="fa fa-check"></i>9.2.2 Anonymous functions and shortcuts</a></li>
<li class="chapter" data-level="" data-path="names-and-values.html"><a href="names-and-values.html#exercise"><i class="fa fa-check"></i>9.2.6.4 Exercise</a></li>
<li class="chapter" data-level="" data-path="functions.html"><a href="functions.html#exercise-1"><i class="fa fa-check"></i>9.2.6.5 Exercise</a></li>
<li><a href="functionals.html#same-type-of-output-as-input-modify">9.4.1 Same type of output as input: <code>modify()</code></a></li>
<li class="chapter" data-level="" data-path="functionals.html"><a href="functionals.html#any-number-of-inputs-pmap-and-friends"><i class="fa fa-check"></i>9.4.5 Any number of inputs: pmap() and friends</a></li>
<li class="chapter" data-level="" data-path="functions.html"><a href="functions.html#exercise-2"><i class="fa fa-check"></i>9.4.6.2 Exercise</a></li>
<li class="chapter" data-level="" data-path="functionals.html"><a href="functionals.html#multiple-inputs"><i class="fa fa-check"></i>9.5.4 Multiple inputs</a></li>
<li class="chapter" data-level="" data-path="functions.html"><a href="functions.html#exercise-3"><i class="fa fa-check"></i>9.6.3.2 Exercise</a></li>
<li class="chapter" data-level="" data-path="functionals.html"><a href="functionals.html#matrices-and-arrays"><i class="fa fa-check"></i>9.7.1 Matrices and arrays</a></li>
<li class="chapter" data-level="" data-path="functions.html"><a href="functions.html#exercise-4"><i class="fa fa-check"></i>9.7.3.2 Exercise</a></li>
</ul></li>
<li class="chapter" data-level="10" data-path="function-factories.html"><a href="function-factories.html"><i class="fa fa-check"></i><b>10</b> Function factories</a><ul>
<li class="chapter" data-level="" data-path="function-factories.html"><a href="function-factories.html#factory-fundamentals"><i class="fa fa-check"></i>10.2 Factory fundamentals</a></li>
<li class="chapter" data-level="" data-path="function-factories.html"><a href="function-factories.html#forcing-evaluation"><i class="fa fa-check"></i>10.2.3 Forcing evaluation</a></li>
<li class="chapter" data-level="10.1" data-path="function-factories.html"><a href="function-factories.html#without-force"><i class="fa fa-check"></i><b>10.1</b> WITHOUT FORCE</a><ul>
<li class="chapter" data-level="10.1.1" data-path="function-factories.html"><a href="function-factories.html#using-force"><i class="fa fa-check"></i><b>10.1.1</b> USING FORCE</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="function-factories.html"><a href="function-factories.html#garbage-collection"><i class="fa fa-check"></i>10.2.5 garbage collection</a></li>
<li class="chapter" data-level="" data-path="names-and-values.html"><a href="names-and-values.html#exercise"><i class="fa fa-check"></i>10.2.6.2 Exercise</a></li>
<li class="chapter" data-level="" data-path="functions.html"><a href="functions.html#exercise-1"><i class="fa fa-check"></i>10.2.6.3 Exercise</a></li>
<li class="chapter" data-level="" data-path="function-factories.html"><a href="function-factories.html#labelling"><i class="fa fa-check"></i>10.3.1 Labelling</a></li>
<li class="chapter" data-level="" data-path="names-and-values.html"><a href="names-and-values.html#exercises"><i class="fa fa-check"></i>10.3.4 Exercises</a></li>
<li class="chapter" data-level="10.2" data-path="function-factories.html"><a href="function-factories.html#factories-and-functionals"><i class="fa fa-check"></i><b>10.2</b> 10.5 factories and functionals</a></li>
</ul></li>
<li class="chapter" data-level="11" data-path="function-operators.html"><a href="function-operators.html"><i class="fa fa-check"></i><b>11</b> Function operators</a><ul>
<li class="chapter" data-level="" data-path="subsetting.html"><a href="subsetting.html#introduction"><i class="fa fa-check"></i>11.1 Introduction</a></li>
<li class="chapter" data-level="" data-path="function-operators.html"><a href="function-operators.html#purrrsafely"><i class="fa fa-check"></i>11.2.1 purrr::safely</a></li>
<li class="chapter" data-level="" data-path="function-operators.html"><a href="function-operators.html#memoise"><i class="fa fa-check"></i>11.2.2 memoise</a></li>
<li class="chapter" data-level="" data-path="names-and-values.html"><a href="names-and-values.html#exercises"><i class="fa fa-check"></i>11.2.3.1 Exercises</a></li>
</ul></li>
<li class="chapter" data-level="12" data-path="base-types.html"><a href="base-types.html"><i class="fa fa-check"></i><b>12</b> Base Types</a><ul>
<li class="chapter" data-level="" data-path="subsetting.html"><a href="subsetting.html#introduction"><i class="fa fa-check"></i>Introduction</a></li>
<li class="chapter" data-level="" data-path="base-types.html"><a href="base-types.html#base-types-1"><i class="fa fa-check"></i>12.3 Base types</a></li>
</ul></li>
<li class="chapter" data-level="13" data-path="s3.html"><a href="s3.html"><i class="fa fa-check"></i><b>13</b> S3</a><ul>
<li class="chapter" data-level="" data-path="s3.html"><a href="s3.html#basics"><i class="fa fa-check"></i>13.2 Basics</a></li>
<li class="chapter" data-level="" data-path="s3.html"><a href="s3.html#classes"><i class="fa fa-check"></i>13.3 Classes</a><ul>
<li class="chapter" data-level="" data-path="s3.html"><a href="s3.html#ipa-helper"><i class="fa fa-check"></i>IPA Helper</a></li>
</ul></li>
<li class="chapter" data-level="" data-path="names-and-values.html"><a href="names-and-values.html#exercises"><i class="fa fa-check"></i>13.3.4.3 Exercises</a></li>
<li class="chapter" data-level="" data-path="conditions.html"><a href="conditions.html#exercises-1"><i class="fa fa-check"></i>13.3.4.4 Exercises</a></li>
<li class="chapter" data-level="" data-path="s3.html"><a href="s3.html#generics"><i class="fa fa-check"></i>13.4.1 Generics</a></li>
<li class="chapter" data-level="" data-path="conditions.html"><a href="conditions.html#exercises-2"><i class="fa fa-check"></i>13.4.4.5 Exercises</a></li>
<li class="chapter" data-level="" data-path="s3.html"><a href="s3.html#object-styles"><i class="fa fa-check"></i>13.5 Object styles</a></li>
<li class="chapter" data-level="" data-path="s3.html"><a href="s3.html#inheritance"><i class="fa fa-check"></i>13.6 Inheritance</a></li>
<li class="chapter" data-level="" data-path="conditions.html"><a href="conditions.html#exercises-3"><i class="fa fa-check"></i>13.4.3.3 Exercises</a></li>
<li class="chapter" data-level="" data-path="s3.html"><a href="s3.html#s3-and-base-types"><i class="fa fa-check"></i>13.7.1 S3 and Base Types</a></li>
<li class="chapter" data-level="" data-path="s3.html"><a href="s3.html#internal-generics"><i class="fa fa-check"></i>13.7.3 Internal Generics</a></li>
<li class="chapter" data-level="" data-path="s3.html"><a href="s3.html#double-dispatch"><i class="fa fa-check"></i>13.7.4 Double Dispatch</a></li>
</ul></li>
<li class="chapter" data-level="14" data-path="r6.html"><a href="r6.html"><i class="fa fa-check"></i><b>14</b> R6</a><ul>
<li class="chapter" data-level="" data-path="r6.html"><a href="r6.html#classes-and-methods"><i class="fa fa-check"></i>14.2 Classes and methods</a></li>
<li class="chapter" data-level="" data-path="r6.html"><a href="r6.html#important-methods"><i class="fa fa-check"></i>14.2.2 Important methods</a></li>
<li class="chapter" data-level="" data-path="r6.html"><a href="r6.html#classes-and-methods-14.2.3"><i class="fa fa-check"></i>Classes and methods 14.2.3</a></li>
<li class="chapter" data-level="" data-path="r6.html"><a href="r6.html#exercises-14.2.6.4"><i class="fa fa-check"></i>Exercises 14.2.6.4</a></li>
<li class="chapter" data-level="" data-path="r6.html"><a href="r6.html#reference-semantics"><i class="fa fa-check"></i>14.4 Reference semantics</a></li>
</ul></li>
<li class="chapter" data-level="15" data-path="s4.html"><a href="s4.html"><i class="fa fa-check"></i><b>15</b> S4</a><ul>
<li class="chapter" data-level="" data-path="s3.html"><a href="s3.html#basics"><i class="fa fa-check"></i>15.2 Basics</a></li>
<li class="chapter" data-level="" data-path="names-and-values.html"><a href="names-and-values.html#exercises"><i class="fa fa-check"></i>15.3.6.2 Exercises</a></li>
<li class="chapter" data-level="" data-path="s4.html"><a href="s4.html#signature"><i class="fa fa-check"></i>Signature</a></li>
<li class="chapter" data-level="" data-path="s4.html"><a href="s4.html#single-dispatch"><i class="fa fa-check"></i>15.5.1 Single dispatch</a></li>
</ul></li>
<li class="chapter" data-level="16" data-path="trade-offs.html"><a href="trade-offs.html"><i class="fa fa-check"></i><b>16</b> Trade-Offs</a><ul>
<li class="chapter" data-level="16.0.1" data-path="trade-offs.html"><a href="trade-offs.html#using-our-example-from-the-s4-chapter"><i class="fa fa-check"></i><b>16.0.1</b> Using our example from the S4 Chapter:</a></li>
<li class="chapter" data-level="" data-path="trade-offs.html"><a href="trade-offs.html#we-can-do-this-with-s3"><i class="fa fa-check"></i>We can do this with S3:</a></li>
</ul></li>
<li class="chapter" data-level="17" data-path="big-picture.html"><a href="big-picture.html"><i class="fa fa-check"></i><b>17</b> 17 Big Picture</a><ul>
<li class="chapter" data-level="" data-path="big-picture.html"><a href="big-picture.html#quosures"><i class="fa fa-check"></i>17.8 Quosures</a></li>
</ul></li>
<li class="chapter" data-level="18" data-path="expressions.html"><a href="expressions.html"><i class="fa fa-check"></i><b>18</b> Expressions</a></li>
<li class="chapter" data-level="19" data-path="quasiquotation.html"><a href="quasiquotation.html"><i class="fa fa-check"></i><b>19</b> Quasiquotation</a><ul>
<li class="chapter" data-level="" data-path="quasiquotation.html"><a href="quasiquotation.html#motivation"><i class="fa fa-check"></i>19.2 Motivation</a></li>
<li class="chapter" data-level="" data-path="quasiquotation.html"><a href="quasiquotation.html#substitution"><i class="fa fa-check"></i>19.3.4 Substitution</a></li>
<li class="chapter" data-level="" data-path="quasiquotation.html"><a href="quasiquotation.html#exercises-19.3.6.5"><i class="fa fa-check"></i>Exercises 19.3.6.5</a></li>
<li class="chapter" data-level="" data-path="quasiquotation.html"><a href="quasiquotation.html#polite-fiction-of"><i class="fa fa-check"></i>19.4.6 Polite fiction of !!</a></li>
<li class="chapter" data-level="" data-path="quasiquotation.html"><a href="quasiquotation.html#nonstandard-asts"><i class="fa fa-check"></i>19.4.7 Nonstandard ASTs</a></li>
<li class="chapter" data-level="" data-path="names-and-values.html"><a href="names-and-values.html#exercises"><i class="fa fa-check"></i>19.4.8.2 Exercises</a></li>
<li class="chapter" data-level="" data-path="quasiquotation.html"><a href="quasiquotation.html#non-quoting"><i class="fa fa-check"></i>Non-quoting</a></li>
<li class="chapter" data-level="" data-path="subsetting.html"><a href="subsetting.html#section"><i class="fa fa-check"></i>19.6 (…)</a></li>
<li><a href="quasiquotation.html#exec">19.6.2 <code>exec()</code></a></li>
<li><a href="quasiquotation.html#dots_list">19.6.3 <code>dots_list()</code></a></li>
<li class="chapter" data-level="" data-path="quasiquotation.html"><a href="quasiquotation.html#with-base-r"><i class="fa fa-check"></i>19.6.4 With base R</a></li>
</ul></li>
<li class="chapter" data-level="20" data-path="evaluation.html"><a href="evaluation.html"><i class="fa fa-check"></i><b>20</b> Evaluation</a><ul>
<li class="chapter" data-level="" data-path="subsetting.html"><a href="subsetting.html#introduction"><i class="fa fa-check"></i>20.1 Introduction</a></li>
<li><a href="evaluation.html#local">20.2.1 <code>local</code></a></li>
<li><a href="evaluation.html#source">20.2.2 <code>source</code></a></li>
<li><a href="evaluation.html#function">20.2.3 <code>function</code></a></li>
<li class="chapter" data-level="" data-path="names-and-values.html"><a href="names-and-values.html#exercises"><i class="fa fa-check"></i>20.2.4.5 Exercises</a></li>
<li class="chapter" data-level="" data-path="evaluation.html"><a href="evaluation.html#dots"><i class="fa fa-check"></i>20.3.3 Dots</a></li>
<li class="chapter" data-level="" data-path="evaluation.html"><a href="evaluation.html#under-the-hood"><i class="fa fa-check"></i>20.3.4 Under the hood</a></li>
<li class="chapter" data-level="" data-path="conditions.html"><a href="conditions.html#exercises-1"><i class="fa fa-check"></i>20.3.6.2 Exercises</a></li>
<li class="chapter" data-level="" data-path="s3.html"><a href="s3.html#basics"><i class="fa fa-check"></i>20.4.1 Basics</a></li>
<li><a href="evaluation.html#subset">20.4.3 <code>subset</code></a></li>
<li><a href="evaluation.html#transform">20.4.5 <code>transform</code></a></li>
<li class="chapter" data-level="" data-path="evaluation.html"><a href="evaluation.html#handling-ambiguity"><i class="fa fa-check"></i>20.5.2 Handling ambiguity</a></li>
<li class="chapter" data-level="" data-path="evaluation.html"><a href="evaluation.html#substitute"><i class="fa fa-check"></i>20.6.1 substitute()</a></li>
<li><a href="evaluation.html#match.call">20.6.2 <code>match.call</code></a></li>
</ul></li>
<li class="divider"></li>
<li><a href="https://github.com/rstudio/bookdown" target="blank">Published with bookdown</a></li>

</ul>

      </nav>
    </div>

    <div class="book-body">
      <div class="body-inner">
        <div class="book-header" role="navigation">
          <h1>
            <i class="fa fa-circle-o-notch fa-spin"></i><a href="./">Advanced R Companion</a>
          </h1>
        </div>

        <div class="page-wrapper" tabindex="-1" role="main">
          <div class="page-inner">

            <section class="normal" id="section-">
<div id="evaluation" class="section level1">
<h1><span class="header-section-number">Chapter 20</span> Evaluation</h1>
<div id="introduction" class="section level2 unnumbered">
<h2>20.1 Introduction</h2>
<div class="question">
<p>There’s an immediate distinction between unquotation (user) and evaluation (developer). What are they?</p>
</div>
<p>Unquoting seems to be “evaluate this one part and then return the expression”
evaluate means “give me the result of this whole expression”</p>
</div>
<div id="local" class="section level2 unnumbered">
<h2>20.2.1 <code>local</code></h2>
<div class="question">
<p>This is such a cool function - where is it used in the wild?</p>
</div>
<p>When wanting to have variables stored in the environment of a function, or if you want to run an expression that produces bindings, but you don’t want those bindings to persist.</p>
<div class="sourceCode" id="cb668"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb668-1" data-line-number="1">counter &lt;-<span class="st"> </span><span class="kw">local</span>({ </a>
<a class="sourceLine" id="cb668-2" data-line-number="2">  i &lt;-<span class="st"> </span><span class="dv">0</span>; <span class="cf">function</span>() { </a>
<a class="sourceLine" id="cb668-3" data-line-number="3">    i &lt;&lt;-<span class="st"> </span>i <span class="op">+</span><span class="st"> </span><span class="dv">1</span>; <span class="kw">print</span>(i)</a>
<a class="sourceLine" id="cb668-4" data-line-number="4">  }</a>
<a class="sourceLine" id="cb668-5" data-line-number="5">})</a>
<a class="sourceLine" id="cb668-6" data-line-number="6"></a>
<a class="sourceLine" id="cb668-7" data-line-number="7"><span class="kw">counter</span>()</a></code></pre></div>
<pre><code>## [1] 1</code></pre>
<div class="sourceCode" id="cb670"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb670-1" data-line-number="1"><span class="kw">counter</span>()</a></code></pre></div>
<pre><code>## [1] 2</code></pre>
<div class="sourceCode" id="cb672"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb672-1" data-line-number="1"><span class="kw">counter</span>()</a></code></pre></div>
<pre><code>## [1] 3</code></pre>
<p>We can also wrap <code>for</code> loops in a <code>local</code> call to avoid the object being iterated over getting assigned to the global environment</p>
<div class="sourceCode" id="cb674"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb674-1" data-line-number="1">f1 &lt;-<span class="st"> </span><span class="cf">function</span>(x) {</a>
<a class="sourceLine" id="cb674-2" data-line-number="2">  <span class="cf">for</span> (x <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="dv">10</span>) {</a>
<a class="sourceLine" id="cb674-3" data-line-number="3">    <span class="co"># do something</span></a>
<a class="sourceLine" id="cb674-4" data-line-number="4">  }</a>
<a class="sourceLine" id="cb674-5" data-line-number="5">  x</a>
<a class="sourceLine" id="cb674-6" data-line-number="6">}</a>
<a class="sourceLine" id="cb674-7" data-line-number="7"></a>
<a class="sourceLine" id="cb674-8" data-line-number="8">f2 &lt;-<span class="st"> </span><span class="cf">function</span>(x) {</a>
<a class="sourceLine" id="cb674-9" data-line-number="9">  <span class="kw">local</span>({</a>
<a class="sourceLine" id="cb674-10" data-line-number="10">    <span class="cf">for</span> (x <span class="cf">in</span> <span class="dv">1</span><span class="op">:</span><span class="dv">10</span>) {</a>
<a class="sourceLine" id="cb674-11" data-line-number="11">      <span class="co"># do something</span></a>
<a class="sourceLine" id="cb674-12" data-line-number="12">    }</a>
<a class="sourceLine" id="cb674-13" data-line-number="13">  })</a>
<a class="sourceLine" id="cb674-14" data-line-number="14">  x</a>
<a class="sourceLine" id="cb674-15" data-line-number="15">}</a>
<a class="sourceLine" id="cb674-16" data-line-number="16"></a>
<a class="sourceLine" id="cb674-17" data-line-number="17"><span class="kw">f1</span>(<span class="st">&quot;hello&quot;</span>)</a>
<a class="sourceLine" id="cb674-18" data-line-number="18"><span class="co">#&gt; [1] 10</span></a>
<a class="sourceLine" id="cb674-19" data-line-number="19"><span class="kw">f2</span>(<span class="st">&quot;hello&quot;</span>)</a>
<a class="sourceLine" id="cb674-20" data-line-number="20"><span class="co">#&gt; [1] &quot;hello&quot;</span></a></code></pre></div>
</div>
<div id="source" class="section level2 unnumbered">
<h2>20.2.2 <code>source</code></h2>
<div class="question">
<p>Expression vectors get a shout out again (they are an aside in the Expression chapter) and while Hadley advises against introducing another data structure, I wanted to make sure my high level understanding was correct: eval can be vectorized if the input is of type <code>expression vector</code> [but not if it’s of type <code>list</code>]?</p>
</div>
<div class="sourceCode" id="cb675"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb675-1" data-line-number="1">exp_vec &lt;-<span class="st"> </span><span class="kw">expression</span>(x &lt;-<span class="st"> </span><span class="dv">4</span>, x)</a>
<a class="sourceLine" id="cb675-2" data-line-number="2"><span class="kw">eval</span>(exp_vec)</a></code></pre></div>
<div class="sourceCode" id="cb676"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb676-1" data-line-number="1">exp_list &lt;-<span class="st"> </span><span class="kw">list2</span>(</a>
<a class="sourceLine" id="cb676-2" data-line-number="2">  rlang<span class="op">::</span><span class="kw">expr</span>(x &lt;-<span class="st"> </span><span class="dv">4</span>),</a>
<a class="sourceLine" id="cb676-3" data-line-number="3">  rlang<span class="op">::</span><span class="kw">expr</span>(x)</a>
<a class="sourceLine" id="cb676-4" data-line-number="4">)</a>
<a class="sourceLine" id="cb676-5" data-line-number="5"><span class="kw">eval</span>(exp_list)</a></code></pre></div>
</div>
<div id="function" class="section level2 unnumbered">
<h2>20.2.3 <code>function</code></h2>
<div class="question">
<p>I think I understand this issue based on the concrete example but can we summarize the “gotcha” here?</p>
</div>
<p>It’s basically that the printing of the function is a lie (because base R doesn’t get it). And that’s dangerous and confusing, so use rlang to make it not a lie.</p>
<div class="sourceCode" id="cb677"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb677-1" data-line-number="1">x &lt;-<span class="st"> </span><span class="dv">10</span></a>
<a class="sourceLine" id="cb677-2" data-line-number="2">y &lt;-<span class="st"> </span><span class="dv">20</span></a>
<a class="sourceLine" id="cb677-3" data-line-number="3">f &lt;-<span class="st"> </span><span class="kw">eval</span>(<span class="kw">expr</span>(<span class="cf">function</span>(x, y) <span class="op">!!</span>x <span class="op">+</span><span class="st"> </span><span class="op">!!</span>y))</a>
<a class="sourceLine" id="cb677-4" data-line-number="4">f</a></code></pre></div>
<pre><code>## function(x, y) !!x + !!y</code></pre>
<div class="sourceCode" id="cb679"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb679-1" data-line-number="1"><span class="kw">f</span>()</a></code></pre></div>
<pre><code>## [1] 30</code></pre>
<div class="sourceCode" id="cb681"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb681-1" data-line-number="1"><span class="kw">attributes</span>(f)</a></code></pre></div>
<pre><code>## $srcref
## function(x, y) !!x + !!y</code></pre>
<div class="sourceCode" id="cb683"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb683-1" data-line-number="1"><span class="kw">attr</span>(f, <span class="st">&quot;srcref&quot;</span>) &lt;-<span class="st"> </span><span class="ot">NULL</span></a>
<a class="sourceLine" id="cb683-2" data-line-number="2">f</a></code></pre></div>
<pre><code>## function (x, y) 
## 10 + 20</code></pre>
<p>The REAL function is <code>10 + 20</code>, but the initial <code>srcref</code> keeps the <code>!!x</code> and <code>!!y</code>, which is meaningless. This might help explain why there’s a problem:</p>
<div class="sourceCode" id="cb685"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb685-1" data-line-number="1">x &lt;-<span class="st"> </span><span class="dv">10</span></a>
<a class="sourceLine" id="cb685-2" data-line-number="2">y &lt;-<span class="st"> </span><span class="dv">20</span></a>
<a class="sourceLine" id="cb685-3" data-line-number="3">f &lt;-<span class="st"> </span><span class="kw">eval</span>(<span class="kw">expr</span>(<span class="cf">function</span>(x, y) <span class="op">!!</span>x <span class="op">+</span><span class="st"> </span><span class="op">!!</span>y))</a>
<a class="sourceLine" id="cb685-4" data-line-number="4">f</a></code></pre></div>
<pre><code>## function(x, y) !!x + !!y</code></pre>
<div class="sourceCode" id="cb687"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb687-1" data-line-number="1"><span class="kw">f</span>()</a></code></pre></div>
<pre><code>## [1] 30</code></pre>
<div class="sourceCode" id="cb689"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb689-1" data-line-number="1">x &lt;-<span class="st"> </span><span class="dv">2000</span></a>
<a class="sourceLine" id="cb689-2" data-line-number="2">y &lt;-<span class="st"> </span><span class="dv">3000</span></a>
<a class="sourceLine" id="cb689-3" data-line-number="3"><span class="kw">f</span>()</a></code></pre></div>
<pre><code>## [1] 30</code></pre>
<div class="sourceCode" id="cb691"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb691-1" data-line-number="1"><span class="co">#&gt; [1] 30</span></a>
<a class="sourceLine" id="cb691-2" data-line-number="2"><span class="kw">attributes</span>(f)</a></code></pre></div>
<pre><code>## $srcref
## function(x, y) !!x + !!y</code></pre>
<div class="sourceCode" id="cb693"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb693-1" data-line-number="1"><span class="co">#&gt; $srcref</span></a>
<a class="sourceLine" id="cb693-2" data-line-number="2"><span class="co">#&gt; function(x, y) !!x + !!y</span></a>
<a class="sourceLine" id="cb693-3" data-line-number="3"><span class="kw">attr</span>(f, <span class="st">&quot;srcref&quot;</span>) &lt;-<span class="st"> </span><span class="ot">NULL</span></a>
<a class="sourceLine" id="cb693-4" data-line-number="4">f</a></code></pre></div>
<pre><code>## function (x, y) 
## 10 + 20
## &lt;bytecode: 0x7f7f25ea2b50&gt;</code></pre>
<div class="sourceCode" id="cb695"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb695-1" data-line-number="1"><span class="co">#&gt; function (x, y) </span></a>
<a class="sourceLine" id="cb695-2" data-line-number="2"><span class="co">#&gt; 10 + 20</span></a>
<a class="sourceLine" id="cb695-3" data-line-number="3"><span class="co">#&gt; &lt;bytecode: 0x000000001421eb90&gt;</span></a></code></pre></div>
</div>
<div id="exercises" class="section level2 unnumbered">
<h2>20.2.4.5 Exercises</h2>
<div class="question">
<p>Can we also go over what is happening in <code>local3</code>?</p>
</div>
<div class="sourceCode" id="cb696"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb696-1" data-line-number="1">local3 &lt;-<span class="st"> </span><span class="cf">function</span>(expr, <span class="dt">envir =</span> <span class="kw">new.env</span>()) {</a>
<a class="sourceLine" id="cb696-2" data-line-number="2">  call &lt;-<span class="st"> </span><span class="kw">substitute</span>(<span class="kw">eval</span>(<span class="kw">quote</span>(expr), envir))</a>
<a class="sourceLine" id="cb696-3" data-line-number="3">  <span class="kw">print</span>(call)</a>
<a class="sourceLine" id="cb696-4" data-line-number="4">  <span class="kw">eval</span>(call, <span class="dt">envir =</span> <span class="kw">parent.frame</span>())</a>
<a class="sourceLine" id="cb696-5" data-line-number="5">}</a>
<a class="sourceLine" id="cb696-6" data-line-number="6"></a>
<a class="sourceLine" id="cb696-7" data-line-number="7"><span class="kw">local3</span>({</a>
<a class="sourceLine" id="cb696-8" data-line-number="8">  x &lt;-<span class="st"> </span><span class="dv">10</span></a>
<a class="sourceLine" id="cb696-9" data-line-number="9">  x <span class="op">*</span><span class="st"> </span><span class="dv">2</span></a>
<a class="sourceLine" id="cb696-10" data-line-number="10">})</a>
<a class="sourceLine" id="cb696-11" data-line-number="11"></a>
<a class="sourceLine" id="cb696-12" data-line-number="12"><span class="kw">exists</span>(<span class="st">&quot;x&quot;</span>)</a></code></pre></div>
<p>It creates a new environment with the calling environment as its parent and then evaluates the expression in that environment.</p>
<p>You are evaluating the call in the execution environment of <code>local3</code>. Its confusing because it’s written as <code>eval(call, envir = parent.frame())</code> but it is important to remember that <code>parent.frame</code> is evaluated in the execution environment of eval.</p>
<p>if instead you had:</p>
<pre><code>pf &lt;- parent.frame()
eval(call, envir = pf)</code></pre>
<p>you would get something else. Because in this case, <code>parent.frame()</code> is evaluated in the execution environment of <code>local3</code> and thus returns <code>.GlobalEnv</code> (presumably you run it from the global env).</p>
</div>
<div id="dots" class="section level2 unnumbered">
<h2>20.3.3 Dots</h2>
<div class="question">
<p>I have no idea what’s happening in this section. Can we go over the point/what this code is showing us?</p>
<div class="sourceCode" id="cb698"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb698-1" data-line-number="1">f &lt;-<span class="st"> </span><span class="cf">function</span>(...) {</a>
<a class="sourceLine" id="cb698-2" data-line-number="2">  x &lt;-<span class="st"> </span><span class="dv">1</span></a>
<a class="sourceLine" id="cb698-3" data-line-number="3">  <span class="kw">g</span>(..., <span class="dt">f =</span> x)</a>
<a class="sourceLine" id="cb698-4" data-line-number="4">}</a>
<a class="sourceLine" id="cb698-5" data-line-number="5"></a>
<a class="sourceLine" id="cb698-6" data-line-number="6">g &lt;-<span class="st"> </span><span class="cf">function</span>(...) {</a>
<a class="sourceLine" id="cb698-7" data-line-number="7">  <span class="kw">enquos</span>(...)</a>
<a class="sourceLine" id="cb698-8" data-line-number="8">}</a>
<a class="sourceLine" id="cb698-9" data-line-number="9"></a>
<a class="sourceLine" id="cb698-10" data-line-number="10">x &lt;-<span class="st"> </span><span class="dv">0</span></a>
<a class="sourceLine" id="cb698-11" data-line-number="11">qs &lt;-<span class="st"> </span><span class="kw">f</span>(<span class="dt">global =</span> x)</a>
<a class="sourceLine" id="cb698-12" data-line-number="12">qs</a></code></pre></div>
</div>
<div class="TODO">
<p>As a preliminary, I note that the following code also illustrates the point:</p>
<div class="sourceCode" id="cb699"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb699-1" data-line-number="1">f &lt;-<span class="st"> </span><span class="cf">function</span>(...) {</a>
<a class="sourceLine" id="cb699-2" data-line-number="2">  x &lt;-<span class="st"> </span><span class="dv">1</span></a>
<a class="sourceLine" id="cb699-3" data-line-number="3">  <span class="kw">g</span>(..., <span class="dt">f =</span> x)</a>
<a class="sourceLine" id="cb699-4" data-line-number="4">}</a>
<a class="sourceLine" id="cb699-5" data-line-number="5">g &lt;-<span class="st"> </span><span class="cf">function</span>(...) {</a>
<a class="sourceLine" id="cb699-6" data-line-number="6">  <span class="kw">enquos</span>(...)</a>
<a class="sourceLine" id="cb699-7" data-line-number="7">}</a>
<a class="sourceLine" id="cb699-8" data-line-number="8">x &lt;-<span class="st"> </span><span class="dv">0</span></a>
<a class="sourceLine" id="cb699-9" data-line-number="9">qs &lt;-<span class="st"> </span><span class="kw">f</span>(x)</a>
<a class="sourceLine" id="cb699-10" data-line-number="10">qs</a></code></pre></div>
<p>I think what he’s trying to say is that if you didn’t have quosures you would have to create a list of environments to match the list of expressions if you wanted your expressions to contain the same names but not necessarily have those names have the same meaning.</p>
<p>But here we have a magical situation where each quosure has the same expression but each environment is different and thus each <code>x</code> will be evaluated differently when the time comes.</p>
<p>I think the real barrier to truly getting it is figuring out a plausible example of wanting the same name to have different meanings in your list of expressions.. and I’m at a loss for that at the moment.</p>
</div>
</div>
<div id="under-the-hood" class="section level2 unnumbered">
<h2>20.3.4 Under the hood</h2>
<div class="question">
<blockquote>
<p>Unfortunately, however, there is no clean way to make ~ a quasiquoting function.</p>
</blockquote>
<p>Can we come up with a (broken) example of trying to quasiquote an object of type <code>formula</code>? I think seeing this fail will help me to understand its limitations</p>
</div>
<div class="TODO">
<p>To do this you would need to recreate the way rlang worked when quosures WERE formulas, probably by pulling the commit prior to the rewrite off of github. It looks like the old method would encode the expr as a formula and then overload the tilde operator so that it does tidy eval instead of..whatever it does normally</p>
</div>
</div>
<div id="exercises-1" class="section level2 unnumbered">
<h2>20.3.6.2 Exercises</h2>
<div class="question">
<p>What is going on here??</p>
<div class="sourceCode" id="cb700"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb700-1" data-line-number="1">enenv &lt;-<span class="st"> </span><span class="cf">function</span>(x){</a>
<a class="sourceLine" id="cb700-2" data-line-number="2">  <span class="kw">get_env</span>(<span class="kw">enquo</span>(x))</a>
<a class="sourceLine" id="cb700-3" data-line-number="3">}</a>
<a class="sourceLine" id="cb700-4" data-line-number="4"></a>
<a class="sourceLine" id="cb700-5" data-line-number="5"><span class="co"># Test</span></a>
<a class="sourceLine" id="cb700-6" data-line-number="6">capture_env &lt;-<span class="st"> </span><span class="cf">function</span>(x){</a>
<a class="sourceLine" id="cb700-7" data-line-number="7">  <span class="kw">enenv</span>(x)</a>
<a class="sourceLine" id="cb700-8" data-line-number="8">}</a>
<a class="sourceLine" id="cb700-9" data-line-number="9"></a>
<a class="sourceLine" id="cb700-10" data-line-number="10"><span class="kw">enenv</span>(x)</a>
<a class="sourceLine" id="cb700-11" data-line-number="11"><span class="co">#&gt; &lt;environment: R_GlobalEnv&gt;</span></a>
<a class="sourceLine" id="cb700-12" data-line-number="12"><span class="kw">capture_env</span>(x)  <span class="co"># functions execution environment is captured</span></a>
<a class="sourceLine" id="cb700-13" data-line-number="13"><span class="co">#&gt; &lt;environment: 0x60a2538&gt;</span></a></code></pre></div>
</div>
<p>The <code>enquo</code> is capturing the environment of the <code>x</code> being passed into enenv, so it returns a different environment (the one inside <code>capture_env</code>) than running <code>enenv(x)</code> on its own</p>
</div>
<div id="basics" class="section level2 unnumbered">
<h2>20.4.1 Basics</h2>
<div class="question">
<p>I am clearly missing something here. What is so special about multiplying across a vector? Is it that data masks allow us to just write <code>y</code> instead of <code>df$y</code>?</p>
</div>
<p>I think the simplicity of the multiplication may be what he’s going for: the reader can focus on the language feature provided without the distraction of a complex computation.</p>
</div>
<div id="subset" class="section level2 unnumbered">
<h2>20.4.3 <code>subset</code></h2>
<div class="question">
<p>What is the <code>eval_tidy</code> doing here?</p>
</div>
<div class="sourceCode" id="cb701"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb701-1" data-line-number="1">subset2 &lt;-<span class="st"> </span><span class="cf">function</span>(data, rows) {</a>
<a class="sourceLine" id="cb701-2" data-line-number="2">  rows &lt;-<span class="st"> </span><span class="kw">enquo</span>(rows)</a>
<a class="sourceLine" id="cb701-3" data-line-number="3">  <span class="co"># creates a quosure out of the enquoted rows</span></a>
<a class="sourceLine" id="cb701-4" data-line-number="4">  <span class="co"># and uses the data as its environment</span></a>
<a class="sourceLine" id="cb701-5" data-line-number="5">  rows_val &lt;-<span class="st"> </span><span class="kw">eval_tidy</span>(rows, data)</a>
<a class="sourceLine" id="cb701-6" data-line-number="6">  <span class="kw">stopifnot</span>(<span class="kw">is.logical</span>(rows_val))</a>
<a class="sourceLine" id="cb701-7" data-line-number="7"></a>
<a class="sourceLine" id="cb701-8" data-line-number="8">  <span class="co"># then subsets the data</span></a>
<a class="sourceLine" id="cb701-9" data-line-number="9">  data[rows_val, , drop =<span class="st"> </span><span class="ot">FALSE</span>]</a>
<a class="sourceLine" id="cb701-10" data-line-number="10">}</a>
<a class="sourceLine" id="cb701-11" data-line-number="11"></a>
<a class="sourceLine" id="cb701-12" data-line-number="12">df &lt;-<span class="st"> </span><span class="kw">subset2</span>(palmerpenguins<span class="op">::</span>penguins, species <span class="op">==</span><span class="st"> &quot;Adelie&quot;</span>)</a>
<a class="sourceLine" id="cb701-13" data-line-number="13"><span class="kw">table</span>(df<span class="op">$</span>species)</a></code></pre></div>
<pre><code>## 
##    Adelie Chinstrap    Gentoo 
##       152         0         0</code></pre>
</div>
<div id="transform" class="section level2 unnumbered">
<h2>20.4.5 <code>transform</code></h2>
<div class="question">
<p>Can we say in words what this one is doing or comment all the lines?</p>
</div>
<div class="sourceCode" id="cb703"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb703-1" data-line-number="1">transform2 &lt;-<span class="st"> </span><span class="cf">function</span>(.data, ...) {</a>
<a class="sourceLine" id="cb703-2" data-line-number="2">  </a>
<a class="sourceLine" id="cb703-3" data-line-number="3">  <span class="co"># create quosures for all the supplied arguments and values</span></a>
<a class="sourceLine" id="cb703-4" data-line-number="4">  dots &lt;-<span class="st"> </span><span class="kw">enquos</span>(...)</a>
<a class="sourceLine" id="cb703-5" data-line-number="5"></a>
<a class="sourceLine" id="cb703-6" data-line-number="6">  <span class="co"># for all argument value pairs</span></a>
<a class="sourceLine" id="cb703-7" data-line-number="7">  <span class="cf">for</span> (i <span class="cf">in</span> <span class="kw">seq_along</span>(dots)) {</a>
<a class="sourceLine" id="cb703-8" data-line-number="8">    <span class="co"># get the names of the arguments</span></a>
<a class="sourceLine" id="cb703-9" data-line-number="9">    name &lt;-<span class="st"> </span><span class="kw">names</span>(dots)[[i]]</a>
<a class="sourceLine" id="cb703-10" data-line-number="10">    <span class="co"># get their values</span></a>
<a class="sourceLine" id="cb703-11" data-line-number="11">    dot &lt;-<span class="st"> </span>dots[[i]]</a>
<a class="sourceLine" id="cb703-12" data-line-number="12"></a>
<a class="sourceLine" id="cb703-13" data-line-number="13">    <span class="co"># add column with names equal to argument names</span></a>
<a class="sourceLine" id="cb703-14" data-line-number="14">    <span class="co"># eval_tidy and values (single column) equal to the evaluated quosure (dot)&quot;</span></a>
<a class="sourceLine" id="cb703-15" data-line-number="15">    .data[[name]] &lt;-<span class="st"> </span><span class="kw">eval_tidy</span>(dot, .data)</a>
<a class="sourceLine" id="cb703-16" data-line-number="16">  }</a>
<a class="sourceLine" id="cb703-17" data-line-number="17"></a>
<a class="sourceLine" id="cb703-18" data-line-number="18">  .data</a>
<a class="sourceLine" id="cb703-19" data-line-number="19">}</a></code></pre></div>
</div>
<div id="handling-ambiguity" class="section level2 unnumbered">
<h2>20.5.2 Handling ambiguity</h2>
<div class="question">
<blockquote>
<p>There are subtle differences in when val is evaluated. If you unquote, val will be early evaluated by enquo(); if you use a pronoun, val will be lazily evaluated by eval_tidy(). These differences are usually unimportant, so pick the form that looks most natural.</p>
</blockquote>
<p>Is there a case where this subtle distinction between <code>.env$val</code> vs <code>!!val</code> matters?</p>
<div class="sourceCode" id="cb704"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb704-1" data-line-number="1">threshold_prefix &lt;-<span class="st"> </span><span class="cf">function</span>(df, val) {</a>
<a class="sourceLine" id="cb704-2" data-line-number="2">  <span class="kw">subset2</span>(df, .data<span class="op">$</span>x <span class="op">&gt;=</span><span class="st"> </span>.env<span class="op">$</span>val)</a>
<a class="sourceLine" id="cb704-3" data-line-number="3">}</a>
<a class="sourceLine" id="cb704-4" data-line-number="4"></a>
<a class="sourceLine" id="cb704-5" data-line-number="5">threshold_bangbang &lt;-<span class="st"> </span><span class="cf">function</span>(df, val) {</a>
<a class="sourceLine" id="cb704-6" data-line-number="6">  <span class="kw">subset2</span>(df, .data<span class="op">$</span>x <span class="op">&gt;=</span><span class="st"> </span><span class="op">!!</span>val)</a>
<a class="sourceLine" id="cb704-7" data-line-number="7">}</a>
<a class="sourceLine" id="cb704-8" data-line-number="8"></a>
<a class="sourceLine" id="cb704-9" data-line-number="9">df &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">x =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">3</span>, <span class="dt">val =</span> <span class="dv">9</span><span class="op">:</span><span class="dv">11</span>)</a>
<a class="sourceLine" id="cb704-10" data-line-number="10"><span class="kw">threshold_prefix</span>(df, <span class="dv">2</span>) <span class="op">==</span><span class="st"> </span><span class="kw">threshold_bangbang</span>(df, <span class="dv">2</span>)</a></code></pre></div>
<pre><code>##      x  val
## 2 TRUE TRUE
## 3 TRUE TRUE</code></pre>
</div>
<p>In the <code>!!</code> case, <code>val</code> is evaluated early, (inside of <code>threshold_x</code>) whereas the <code>.env</code> case evaluated later (in the <code>eval_tidy</code>)</p>
<p>Tyler Grant Smith:m: 21 minutes ago
this could cause problems if, for example, the val in threshold_x was altered after subset2 was called, but before the eval_tidy</p>
<div class="sourceCode" id="cb706"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb706-1" data-line-number="1">subset2 &lt;-<span class="st"> </span><span class="cf">function</span>(data, rows) {</a>
<a class="sourceLine" id="cb706-2" data-line-number="2">  rows &lt;-<span class="st"> </span><span class="kw">enquo</span>(rows)</a>
<a class="sourceLine" id="cb706-3" data-line-number="3">  <span class="co"># change val from 2 to 3, breaking things</span></a>
<a class="sourceLine" id="cb706-4" data-line-number="4">  <span class="kw">env_bind</span>(<span class="kw">caller_env</span>(), <span class="dt">val =</span> <span class="dv">3</span>)</a>
<a class="sourceLine" id="cb706-5" data-line-number="5">  rows_val &lt;-<span class="st"> </span><span class="kw">eval_tidy</span>(rows, data)</a>
<a class="sourceLine" id="cb706-6" data-line-number="6">  <span class="kw">stopifnot</span>(<span class="kw">is.logical</span>(rows_val))</a>
<a class="sourceLine" id="cb706-7" data-line-number="7">  data[rows_val, , drop =<span class="st"> </span><span class="ot">FALSE</span>]</a>
<a class="sourceLine" id="cb706-8" data-line-number="8">}</a></code></pre></div>
</div>
<div id="substitute" class="section level2 unnumbered">
<h2>20.6.1 substitute()</h2>
<div class="question">
<p>Why exactly can’t we use <code>subset</code> with <code>map</code>?</p>
<p>This works, not sure why the book says it wouldn’t….</p>
<div class="sourceCode" id="cb707"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb707-1" data-line-number="1">subset_base &lt;-<span class="st"> </span><span class="cf">function</span>(data, rows) {</a>
<a class="sourceLine" id="cb707-2" data-line-number="2">  rows &lt;-<span class="st"> </span><span class="kw">substitute</span>(rows)</a>
<a class="sourceLine" id="cb707-3" data-line-number="3">  rows_val &lt;-<span class="st"> </span><span class="kw">eval</span>(rows, data, <span class="kw">caller_env</span>())</a>
<a class="sourceLine" id="cb707-4" data-line-number="4">  <span class="kw">stopifnot</span>(<span class="kw">is.logical</span>(rows_val))</a>
<a class="sourceLine" id="cb707-5" data-line-number="5">  data[rows_val, , drop =<span class="st"> </span><span class="ot">FALSE</span>]</a>
<a class="sourceLine" id="cb707-6" data-line-number="6">}</a>
<a class="sourceLine" id="cb707-7" data-line-number="7"></a>
<a class="sourceLine" id="cb707-8" data-line-number="8"><span class="kw">local</span>({</a>
<a class="sourceLine" id="cb707-9" data-line-number="9">  zzz &lt;-<span class="st"> </span><span class="dv">2</span></a>
<a class="sourceLine" id="cb707-10" data-line-number="10">  dfs &lt;-<span class="st"> </span><span class="kw">list</span>(<span class="kw">data.frame</span>(<span class="dt">x =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">3</span>), <span class="kw">data.frame</span>(<span class="dt">x =</span> <span class="dv">4</span><span class="op">:</span><span class="dv">6</span>))</a>
<a class="sourceLine" id="cb707-11" data-line-number="11">  <span class="kw">map</span>(dfs, <span class="op">~</span><span class="kw">subset_base</span>(.x, x <span class="op">==</span><span class="st"> </span>zzz))</a>
<a class="sourceLine" id="cb707-12" data-line-number="12">})</a></code></pre></div>
<pre><code>## [[1]]
##   x
## 2 2
## 
## [[2]]
## [1] x
## &lt;0 rows&gt; (or 0-length row.names)</code></pre>
</div>
<div class="TODO">

</div>
<div class="question">
<blockquote>
<p>Calling subset() from another function requires some care: you have to use substitute() to capture a call to subset() complete expression</p>
</blockquote>
<p>Why?!</p>
</div>
<p>No reason to expect this to work:</p>
<div class="sourceCode" id="cb709"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb709-1" data-line-number="1">test &lt;-<span class="st"> </span><span class="cf">function</span>(df, expr) {</a>
<a class="sourceLine" id="cb709-2" data-line-number="2">  <span class="kw">subset</span>(df, expr)</a>
<a class="sourceLine" id="cb709-3" data-line-number="3">}</a>
<a class="sourceLine" id="cb709-4" data-line-number="4"></a>
<a class="sourceLine" id="cb709-5" data-line-number="5"><span class="kw">test</span>(mtcars, cyl <span class="op">&gt;</span><span class="st"> </span><span class="dv">4</span>)</a></code></pre></div>
<pre><code>#&gt; Error in eval(e, x, parent.frame()): object &#39;cyl&#39; not found</code></pre>
<p>substitute only looks at the expression from which it was called. this doesn’t work because subset sees <code>substitute(expr)</code>, not <code>cyl &gt; 4</code></p>
<div class="sourceCode" id="cb711"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb711-1" data-line-number="1">test &lt;-<span class="st"> </span><span class="cf">function</span>(df, expr) {</a>
<a class="sourceLine" id="cb711-2" data-line-number="2">  <span class="kw">subset</span>(df, <span class="kw">substitute</span>(expr))</a>
<a class="sourceLine" id="cb711-3" data-line-number="3">}</a>
<a class="sourceLine" id="cb711-4" data-line-number="4"><span class="kw">test</span>(mtcars, cyl <span class="op">&gt;</span><span class="st"> </span><span class="dv">4</span>)</a></code></pre></div>
<pre><code>#&gt; Error in subset.data.frame(df, substitute(expr)): &#39;subset&#39; must be logical</code></pre>
<p>so instead, we are going to build the call to <code>subset</code>, substituting in what was passed as arguments, and then eval the call.</p>
<div class="sourceCode" id="cb713"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb713-1" data-line-number="1">test &lt;-<span class="st"> </span><span class="cf">function</span>(df, expr) {</a>
<a class="sourceLine" id="cb713-2" data-line-number="2">  subset_call &lt;-<span class="st"> </span><span class="kw">substitute</span>(<span class="kw">subset</span>(df, expr))</a>
<a class="sourceLine" id="cb713-3" data-line-number="3">  <span class="kw">print</span>(subset_call)</a>
<a class="sourceLine" id="cb713-4" data-line-number="4">  <span class="kw">eval</span>(subset_call)</a>
<a class="sourceLine" id="cb713-5" data-line-number="5">}</a>
<a class="sourceLine" id="cb713-6" data-line-number="6"><span class="kw">test</span>(mtcars, cyl <span class="op">&gt;</span><span class="st"> </span><span class="dv">4</span>)</a></code></pre></div>
<pre><code>#&gt; subset(mtcars, cyl &gt; 4)</code></pre>
</div>
<div id="match.call" class="section level2 unnumbered">
<h2>20.6.2 <code>match.call</code></h2>
<div class="question">
<p>Can we speak more about the differences in these two functions and their pros and cons?</p>
</div>
<div class="sourceCode" id="cb715"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb715-1" data-line-number="1">resample_lm2 &lt;-<span class="st"> </span><span class="cf">function</span>(formula, data, <span class="dt">env =</span> <span class="kw">caller_env</span>()) {</a>
<a class="sourceLine" id="cb715-2" data-line-number="2">  formula &lt;-<span class="st"> </span><span class="kw">enexpr</span>(formula)</a>
<a class="sourceLine" id="cb715-3" data-line-number="3">  resample_data &lt;-<span class="st"> </span><span class="kw">resample</span>(data, <span class="dt">n =</span> <span class="kw">nrow</span>(data))</a>
<a class="sourceLine" id="cb715-4" data-line-number="4"></a>
<a class="sourceLine" id="cb715-5" data-line-number="5">  lm_env &lt;-<span class="st"> </span><span class="kw">env</span>(env, <span class="dt">resample_data =</span> resample_data)</a>
<a class="sourceLine" id="cb715-6" data-line-number="6">  lm_call &lt;-<span class="st"> </span><span class="kw">expr</span>(<span class="kw">lm</span>(<span class="op">!!</span>formula, <span class="dt">data =</span> resample_data))</a>
<a class="sourceLine" id="cb715-7" data-line-number="7">  <span class="kw">expr_print</span>(lm_call)</a>
<a class="sourceLine" id="cb715-8" data-line-number="8">  <span class="kw">eval</span>(lm_call, lm_env)</a>
<a class="sourceLine" id="cb715-9" data-line-number="9">}</a>
<a class="sourceLine" id="cb715-10" data-line-number="10"><span class="kw">resample_lm2</span>(y <span class="op">~</span><span class="st"> </span>x, <span class="dt">data =</span> df)</a></code></pre></div>
<div class="sourceCode" id="cb716"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb716-1" data-line-number="1">resample_lm0 &lt;-<span class="st"> </span><span class="cf">function</span>(</a>
<a class="sourceLine" id="cb716-2" data-line-number="2">  formula, data,</a>
<a class="sourceLine" id="cb716-3" data-line-number="3">  <span class="dt">resample_data =</span> data[<span class="kw">sample</span>(<span class="kw">nrow</span>(data), <span class="dt">replace =</span> <span class="ot">TRUE</span>), ,</a>
<a class="sourceLine" id="cb716-4" data-line-number="4">                       <span class="dt">drop =</span> <span class="ot">FALSE</span>],</a>
<a class="sourceLine" id="cb716-5" data-line-number="5">  <span class="dt">env =</span> <span class="kw">current_env</span>()</a>
<a class="sourceLine" id="cb716-6" data-line-number="6">) {</a>
<a class="sourceLine" id="cb716-7" data-line-number="7">  formula &lt;-<span class="st"> </span><span class="kw">enexpr</span>(formula)</a>
<a class="sourceLine" id="cb716-8" data-line-number="8"></a>
<a class="sourceLine" id="cb716-9" data-line-number="9">  lm_call &lt;-<span class="st"> </span><span class="kw">expr</span>(<span class="kw">lm</span>(<span class="op">!!</span>formula, <span class="dt">data =</span> resample_data))</a>
<a class="sourceLine" id="cb716-10" data-line-number="10">  <span class="kw">expr_print</span>(lm_call)</a>
<a class="sourceLine" id="cb716-11" data-line-number="11">  <span class="kw">eval</span>(lm_call, env)</a>
<a class="sourceLine" id="cb716-12" data-line-number="12">}</a>
<a class="sourceLine" id="cb716-13" data-line-number="13"></a>
<a class="sourceLine" id="cb716-14" data-line-number="14">df &lt;-<span class="st"> </span><span class="kw">data.frame</span>(<span class="dt">x =</span> <span class="dv">1</span><span class="op">:</span><span class="dv">10</span>, <span class="dt">y =</span> <span class="dv">5</span> <span class="op">+</span><span class="st"> </span><span class="dv">3</span> <span class="op">*</span><span class="st"> </span>(<span class="dv">1</span><span class="op">:</span><span class="dv">10</span>) <span class="op">+</span><span class="st"> </span><span class="kw">round</span>(<span class="kw">rnorm</span>(<span class="dv">10</span>), <span class="dv">2</span>))</a>
<a class="sourceLine" id="cb716-15" data-line-number="15">(resamp_lm1 &lt;-<span class="st"> </span><span class="kw">resample_lm0</span>(y <span class="op">~</span><span class="st"> </span>x, <span class="dt">data =</span> df))</a></code></pre></div>
<p>I think these two functions should work identically assuming formula and data are the only two inputs that are set by the user. (The results will differ unless a seed is set.)</p>
<p>I suppose the <code>resample_lm0()</code> here provides more flexibility to the user (compared to <code>resample_lm2()</code>, i.e. the user can specify <code>resample_data</code> (since it’s an argument) instead of being “forced” to use the custom function <code>resample()</code>, which is embedded in the body of <code>resample_lm2()</code>.</p>
<p>Downside to <code>resample_lm0</code> is that there might be too much flexibility. Yes, <code>resample_data</code> is customizable, but so is <code>env</code>. What if the user changes <code>env = current_env()</code> to <code>env = caller_env()</code>? Then the function breaks.</p>
<div class="question">
<p>Is the closest equivalent to <code>deparse(substitute(x))</code> with rlang <code>expr_text(enexpr(x))</code> (assuming this is in a function, hence the <code>en</code> in <code>enexpr</code>)?</p>
</div>
<div class="sourceCode" id="cb717"><pre class="sourceCode r"><code class="sourceCode r"><a class="sourceLine" id="cb717-1" data-line-number="1">penguins &lt;-<span class="st"> </span>palmerpenguins<span class="op">::</span>penguins</a>
<a class="sourceLine" id="cb717-2" data-line-number="2">add_bleh &lt;-<span class="st"> </span><span class="cf">function</span>(df, <span class="dt">nm =</span> <span class="kw">deparse</span>(<span class="kw">substitute</span>(df))) {</a>
<a class="sourceLine" id="cb717-3" data-line-number="3">  col_out &lt;-<span class="st"> </span><span class="kw">sym</span>(<span class="kw">sprintf</span>(<span class="st">&#39;new_%s_col&#39;</span>, nm))</a>
<a class="sourceLine" id="cb717-4" data-line-number="4">  df <span class="op">%&gt;%</span><span class="st"> </span></a>
<a class="sourceLine" id="cb717-5" data-line-number="5"><span class="st">    </span><span class="kw">mutate</span>(<span class="op">!!</span>col_out <span class="op">:</span><span class="er">=</span><span class="st"> &#39;bleh&#39;</span>)</a>
<a class="sourceLine" id="cb717-6" data-line-number="6">}</a>
<a class="sourceLine" id="cb717-7" data-line-number="7"><span class="kw">add_bleh</span>(penguins) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">slice</span>(<span class="dv">1</span>) <span class="op">%&gt;%</span><span class="st"> </span><span class="kw">glimpse</span>()</a></code></pre></div>
<pre><code>## Rows: 1
## Columns: 9
## $ species           &lt;fct&gt; Adelie
## $ island            &lt;fct&gt; Torgersen
## $ bill_length_mm    &lt;dbl&gt; 39.1
## $ bill_depth_mm     &lt;dbl&gt; 18.7
## $ flipper_length_mm &lt;int&gt; 181
## $ body_mass_g       &lt;int&gt; 3750
## $ sex               &lt;fct&gt; male
## $ year              &lt;int&gt; 2007
## $ new_penguins_col  &lt;chr&gt; &quot;bleh&quot;</code></pre>
<div class="TODO">

</div>
<div class="question">
<p>In <a href="https://community.rstudio.com/t/quasiquotation-inside-a-formula/14929/11">this thread</a> Lionel says &quot;<code>enexpr</code> should almost never be used. So when should it?</p>
</div>
<p>Seems like when wrapping a base NSE function like <code>lm</code> or trying to <code>deparse(substitute(x))</code> using <code>rlang</code></p>


</div>
</div>
            </section>

          </div>
        </div>
      </div>
<a href="quasiquotation.html" class="navigation navigation-prev navigation-unique" aria-label="Previous page"><i class="fa fa-angle-left"></i></a>

    </div>
  </div>
<script src="libs/gitbook-2.6.7/js/app.min.js"></script>
<script src="libs/gitbook-2.6.7/js/lunr.js"></script>
<script src="libs/gitbook-2.6.7/js/clipboard.min.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-search.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-sharing.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-fontsettings.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-bookdown.js"></script>
<script src="libs/gitbook-2.6.7/js/jquery.highlight.js"></script>
<script src="libs/gitbook-2.6.7/js/plugin-clipboard.js"></script>
<script>
gitbook.require(["gitbook"], function(gitbook) {
gitbook.start({
"sharing": {
"github": false,
"facebook": true,
"twitter": true,
"linkedin": false,
"weibo": false,
"instapaper": false,
"vk": false,
"all": ["facebook", "twitter", "linkedin", "weibo", "instapaper"]
},
"fontsettings": {
"theme": "white",
"family": "sans",
"size": 2
},
"edit": {
"link": "https://github.com/rstudio/bookdown-demo/edit/master/20-evaluation.Rmd",
"text": "Edit"
},
"history": {
"link": null,
"text": null
},
"view": {
"link": null,
"text": null
},
"download": ["AdvancedR_Companion.pdf", "AdvancedR_Companion.epub"],
"toc": {
"collapse": "section"
}
});
});
</script>

</body>

</html>
